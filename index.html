<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KlangKiste V77.4 (Final Fix)</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2ecc71">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link rel="icon" type="image/png" href="assets/icons/icon.png">
    <link rel="apple-touch-icon" href="assets/icons/icon.png">

    <style>
        /* --- GRUNDDESIGN --- */
        :root {
            --bg-color: #f4f7f6;
            --green-safe: #2ecc71;
            --orange-warn: #f1c40f;
            --red-danger: #ff4757;
            --blue-time: #3498db;
            --purple-admin: #9b59b6;
            --yellow-btn: #f1c40f;
            --blue-btn: #3498db;
            --purple-btn: #9b59b6;
            --btn-color: #dfe4ea;
            --text: #2f3542;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text);
            margin: 0; height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }

        #black-curtain {
            display: none;
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: black;
            z-index: 99999;
            pointer-events: auto;
        }

        /* KIDS MODE UI */
        #kids-mode {
            display: none; 
            position: fixed; 
            top: 0; left: 0; right: 0; bottom: 0;
            width: 100%; height: 100%;
            flex-direction: column;
            align-items: center; justify-content: flex-start;
            background-color: #2c3e50;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            padding: 20px; padding-top: 60px;
            box-sizing: border-box;
            transition: background 0.3s ease;
            z-index: 50; 
            overflow-y: auto; 
            overflow-x: hidden;
        }
        
        .kids-text-shadow {
            text-shadow: 0 1px 3px rgba(255,255,255, 0.8);
            background: rgba(255, 255, 255, 0.65);
            padding: 5px 15px;
            border-radius: 15px;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: inline-block;
        }

        #track-title-display {
            font-size: 2.2rem; font-weight: 800; color: #2c3e50;
            margin-bottom: 20px; text-align: center; width: 95%;
            line-height: 1.1; 
            display: -webkit-box; -webkit-line-clamp: 3; 
            -webkit-box-orient: vertical; overflow: hidden; 
            white-space: normal; min-height: 6.5rem; 
            margin-top: 15px;
        }
        
        #playlist-info {
            font-size: 1rem; color: #f1f2f6; text-shadow: 0 1px 2px black;
            margin-top: -15px; margin-bottom: 10px; font-weight: bold;
            max-width: 90%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        #album-art-container {
            width: 45vw; height: 45vw; border-radius: 20px;
            margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            background-color: #eee; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            border: 4px solid white; position: relative;
        }

        #album-img { width: 100%; height: 100%; object-fit: cover; display: none; }
        #album-placeholder { font-size: 60px; color: #ccc; }

        #sleep-indicator {
            position: absolute; top: 10px; right: 10px; font-size: 16px;
            background: rgba(255,255,255,0.9); padding: 5px 10px;
            border-radius: 12px; display: none; color: #333;
            font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
        }

        /* CONTROLS */
        .controls-main {
            display: flex; align-items: center; justify-content: center;
            gap: 25px; margin-bottom: 15px; width: 100%;
        }

        #volume-display-container {
            width: 85%; height: 25px; background-color: rgba(255,255,255,0.7);
            border-radius: 15px; overflow: hidden; border: 1px solid rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        #volume-bar {
            height: 100%; width: 50%; background-color: var(--green-safe);
            transition: width 0.2s, background-color 0.5s;
        }

        .controls-nav-row {
            display: flex; align-items: center; justify-content: center;
            gap: 20px; width: 100%; margin-bottom: 40px; 
        }
        
        .btn-control {
            border: none; border-radius: 50%; cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15); display: flex;
            align-items: center; justify-content: center; font-weight: bold;
            transition: transform 0.1s; color: #576574; 
        }

        .btn-control:active { transform: scale(0.92); }
        .btn-control svg { width: 50%; height: 50%; fill: currentColor; }

        .btn-play {
            width: 110px; height: 110px; background-color: var(--green-safe); color: white;
        }
        .btn-play svg { width: 60%; height: 60%; }

        .btn-secondary {
            width: 75px; height: 75px; background-color: var(--btn-color); color: #2f3542;
        }

        .btn-colorful-vol-down { background-color: var(--yellow-btn) !important; color: #333 !important; }
        .btn-colorful-vol-up { background-color: var(--red-danger) !important; color: white !important; }
        .btn-colorful-back { background-color: var(--blue-btn) !important; color: white !important; }
        .btn-colorful-skip { background-color: var(--purple-btn) !important; color: white !important; }
        .btn-colorful-rewind { background-color: #e17055 !important; color: white !important; }
        .btn-colorful-next { background-color: #00cec9 !important; color: white !important; }

        #time-container {
            width: 90%; height: 45px; background-color: rgba(255,255,255, 0.8);
            border-radius: 12px; position: relative; overflow: hidden;
            border: 1px solid rgba(0,0,0,0.1); cursor: pointer; margin-top: auto; 
            margin-bottom: 20px;
        }
        #time-progress { height: 100%; width: 0%; background-color: var(--blue-time); transition: width 0.5s linear; }
        #time-text {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            color: #2c3e50; font-weight: bold; font-size: 1.3rem;
            text-shadow: 0 0 2px rgba(255,255,255,0.8);
            font-variant-numeric: tabular-nums;
        }
        
        /* --- LIBRARY MODE --- */
        #library-mode {
            display: none; 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #2c3e50;
            z-index: 60;
            overflow-y: auto;
            padding: 20px; box-sizing: border-box;
            padding-top: 50px; 
            padding-bottom: 90px;
        }

        .lib-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; margin-top: 10px;
        }

        .lib-title {
            color: white; font-size: 1.5rem; font-weight: bold; text-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* Filter Leiste */
        .filter-scroll-container {
            display: flex; gap: 10px; overflow-x: auto; 
            padding-bottom: 15px; 
            padding-top: 5px;
            margin-bottom: 20px;
            scrollbar-width: none;
            min-height: 55px;
            flex-shrink: 0;
        }
        .filter-scroll-container::-webkit-scrollbar { display: none; }

        .filter-chip {
            background: rgba(255,255,255,0.2); color: white;
            padding: 8px 16px; border-radius: 20px; white-space: nowrap;
            font-size: 0.9rem; border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.2s; cursor: pointer;
            height: 36px; display: flex; align-items: center;
        }
        .filter-chip.active {
            background: var(--green-safe); border-color: var(--green-safe); font-weight: bold;
            box-shadow: 0 4px 10px rgba(46, 204, 113, 0.4);
        }

        /* Recent Section */
        .section-title { 
            color: #dfe6e9; font-size: 1.1rem; 
            margin-bottom: 15px; margin-top: 10px; 
            font-weight: bold; 
            clear: both;
        }
        
        .recent-grid {
            display: flex; gap: 15px; overflow-x: auto; padding-bottom: 15px; margin-bottom: 25px;
        }
        .recent-card {
            min-width: 120px; width: 120px; display: flex; flex-direction: column; gap: 5px; position: relative;
        }

        /* Main Grid */
        .library-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
            padding-bottom: 20px;
        }

        .lib-card {
            background: white; border-radius: 15px; overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: transform 0.1s; position: relative;
        }
        .lib-card:active { transform: scale(0.96); }

        .lib-cover-wrap {
            width: 100%; aspect-ratio: 1 / 1; background: #eee;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden; position: relative;
        }
        .lib-cover-img { width: 100%; height: 100%; object-fit: cover; }
        .lib-placeholder { font-size: 40px; }

        /* CHECKMARK */
        .completed-badge {
            position: absolute; bottom: 5px; right: 5px;
            background: #2ecc71; color: white; border-radius: 50%;
            width: 28px; height: 28px; display: flex;
            align-items: center; justify-content: center;
            font-size: 16px; border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.4); z-index: 10;
        }

        .lib-card-body { padding: 10px; }
        .lib-card-title {
            font-size: 0.9rem; font-weight: bold; color: #2d3436;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
            line-height: 1.2; height: 2.4em;
        }
        .lib-meta-tag {
            font-size: 0.7rem; color: #636e72; margin-top: 5px; display: block;
        }

        .lib-card-info-btn {
            position: absolute; top: 8px; right: 8px;
            width: 30px; height: 30px; border-radius: 50%;
            background: rgba(255,255,255,0.9);
            color: #2980b9; border: none;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-family: serif; font-size: 1.1rem; font-style: italic;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 5;
        }

        #btn-close-lib {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: var(--red-danger); color: white;
            padding: 15px 30px; border-radius: 30px; border: none;
            font-size: 1.1rem; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 70;
        }

        #btn-open-lib {
            position: fixed; top: 20px; left: 20px;
            background: rgba(255,255,255,0.25); color: white;
            border: none; width: 55px; height: 55px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(5px); 
            z-index: 100;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        /* INFO MODAL */
        #lib-info-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 80;
            align-items: center; justify-content: center; padding: 20px; box-sizing: border-box;
        }
        .info-modal-content {
            background: white; width: 100%; max-width: 400px; max-height: 80vh;
            border-radius: 20px; padding: 25px; overflow-y: auto;
            position: relative; text-align: center;
        }
        .info-modal-cover {
            width: 120px; height: 120px; border-radius: 10px; object-fit: cover;
            margin-bottom: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .info-modal-h { font-size: 1.2rem; font-weight: bold; color: #2c3e50; margin-bottom: 5px; }
        .info-modal-meta { color: #7f8c8d; font-size: 0.9rem; margin-bottom: 15px; }
        .info-modal-desc { 
            text-align: left; font-size: 0.95rem; line-height: 1.5; color: #34495e; 
            background: #f7f9fa; padding: 15px; border-radius: 10px;
        }
        .btn-close-modal {
            background: #2ecc71; color: white; border: none; padding: 10px 20px;
            border-radius: 20px; margin-top: 20px; font-weight: bold; width: 100%;
        }

        /* STATS MODAL & TIMELINE */
        #stats-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #2d3436; 
            z-index: 20000;
            padding: 20px; box-sizing: border-box; flex-direction: column; overflow-y: auto;
        }
        .stats-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; border-bottom: 1px solid #555; padding-bottom: 10px;
            position: relative; 
        }
        .stats-title { font-size: 1.5rem; color: #74b9ff; font-weight: bold; }
        
        .stats-close-btn { 
            background: #e74c3c; border: none; color: white; width: 45px; height: 45px; 
            border-radius: 50%; font-weight: bold; font-size: 1.2rem; 
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            position: relative; z-index: 20001; pointer-events: auto;
        }
        .stats-close-btn:active { transform: scale(0.9); }

        .stat-card {
            background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px;
            margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1);
        }
        .stat-val-big { font-size: 2rem; font-weight: bold; color: #2ecc71; margin-bottom: 5px; }
        .stat-label { font-size: 0.9rem; color: #aaa; text-transform: uppercase; letter-spacing: 1px; }
        
        .stats-toggle-btn {
            background: #555; color: #ddd; border: none; padding: 10px 15px;
            border-radius: 20px; font-weight: bold; font-size: 0.9rem;
            cursor: pointer; transition: all 0.2s; flex: 1; text-align: center;
        }
        .stats-toggle-btn.active {
            background: #3498db; color: white; box-shadow: 0 4px 10px rgba(52, 152, 219, 0.4);
        }
        
        /* Balken Diagramm Simple */
        .chart-row { display: flex; align-items: center; margin-bottom: 8px; font-size: 0.85rem; }
        .chart-label { width: 120px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #dfe6e9; }
        .chart-bar-bg { flex: 1; height: 12px; background: rgba(255,255,255,0.1); border-radius: 6px; overflow: hidden; margin-left: 10px; }
        .chart-bar-fill { height: 100%; background: #3498db; width: 0%; border-radius: 6px; transition: width 0.5s; }
        .chart-val { width: 40px; text-align: right; color: #aaa; font-size: 0.8rem; margin-left: 5px; }

        /* --- TIMELINE STATS DESIGN --- */
        .timeline-container {
            margin-top: 20px;
            border-left: 2px solid #555;
            padding-left: 20px;
            margin-left: 10px;
        }
        .timeline-item {
            position: relative;
            margin-bottom: 20px;
        }
        .timeline-dot {
            position: absolute;
            left: -26px; top: 0;
            width: 10px; height: 10px;
            border-radius: 50%;
            background: #3498db;
            border: 2px solid #2d3436;
        }
        .timeline-time {
            font-size: 0.75rem; color: #aaa; margin-bottom: 2px; font-family: monospace;
        }
        .timeline-content {
            background: rgba(255,255,255,0.05);
            padding: 10px; border-radius: 6px;
            font-size: 0.9rem; color: #dfe6e9;
        }
        .timeline-detail {
            font-size: 0.8rem; color: #7f8c8d; margin-top: 5px; font-style: italic;
        }
        .tl-icon { margin-right: 5px; }

        /* PARENT MODE UI */
        #parent-mode {
            display: flex; flex-direction: column; padding: 20px;
            height: 100vh; background-color: #2d3436; color: white;
            overflow-y: auto;
            z-index: 10;
        }

        .card {
            background: rgba(255,255,255,0.1); padding: 15px;
            border-radius: 10px; margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .card.editing-highlight {
            border: 2px solid #3498db;
            background: rgba(52, 152, 219, 0.1);
        }

        h2 { margin-top: 0; font-size: 1.1rem; color: #74b9ff; }

        input[type="file"], input[type="text"], select {
            width: 100%; padding: 12px; background: rgba(0,0,0,0.3);
            border: 1px solid #555; border-radius: 5px; color: white;
            box-sizing: border-box; margin-bottom: 10px;
        }
        input[type="color"] {
            width: 100%; height: 50px; padding: 5px; background: none; border: 1px solid #555; cursor: pointer;
        }

        .checkbox-wrapper { display: flex; align-items: center; margin-bottom: 15px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px;}
        .checkbox-wrapper input { width: auto; margin-right: 15px; transform: scale(1.5); }
        .checkbox-wrapper span { font-size: 0.9em; }

        label { display: block; margin-bottom: 5px; font-size: 0.9em; color: #aaa; }
        
        .file-info { 
            font-size: 0.8em; color: #00cec9; margin-top:-5px; margin-bottom: 10px; display: block; font-style: italic; 
            white-space: normal; 
            word-wrap: break-word; 
            word-break: break-all;
            line-height: 1.3;
        }

        button.btn-admin {
            background-color: #74b9ff; border: none; padding: 12px;
            border-radius: 8px; color: #2d3436; font-weight: bold;
            font-size: 16px; width: 100%; margin-top: 10px; cursor: pointer;
        }
        button.btn-admin:disabled {
            opacity: 0.5; cursor: not-allowed; filter: grayscale(100%);
        }

        .btn-io-group { display: flex; gap: 10px; margin-top: 10px; }
        .btn-export { background-color: var(--purple-admin); color: white; }
        .btn-import { background-color: var(--green-safe); color: white; position: relative;}
        
        #import-file-hidden, #bg-img-hidden {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; cursor: pointer;
        }

        .btn-switch-kids {
            background-color: var(--green-safe); color: white; padding: 15px;
            border: none; border-radius: 10px; font-size: 1.2rem;
            font-weight: bold; width: 100%; margin-bottom: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .hint-text {
            background: rgba(255, 165, 2, 0.2); padding: 10px;
            border-radius: 5px; font-size: 0.85em; margin-bottom: 20px;
            border-left: 3px solid orange;
        }
        
        .warn-text {
            background: rgba(231, 76, 60, 0.2); padding: 10px;
            border-radius: 5px; font-size: 0.85em; margin-top: 5px; margin-bottom: 15px;
            border-left: 3px solid #e74c3c; color: #e74c3c; font-weight: bold;
        }
        
        .info-box-blue {
            background: rgba(52, 152, 219, 0.2); padding: 10px;
            border-radius: 5px; font-size: 0.85em; margin-bottom: 10px;
            border-left: 3px solid #3498db; color: #dfe6e9;
        }

        .footer-info {
            margin-top: auto; padding-top: 20px; padding-bottom: 20px;
            text-align: center; font-size: 0.75em; color: #888;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .footer-info a { color: #74b9ff; text-decoration: none; font-weight: bold; }
        .footer-info a:hover { text-decoration: underline; }

        /* --- ADMIN GRID / LIST VIEW --- */
        .admin-view-controls {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px;
        }
        .view-toggle-btn {
            background: none; border: 1px solid #7f8c8d; color: #dfe6e9;
            padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-left: 5px;
        }
        .view-toggle-btn.active {
            background: #3498db; border-color: #3498db; color: white;
        }

        .admin-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
        }
        
        .admin-list {
            display: flex; flex-direction: column; gap: 5px; /* List styling */
        }

        /* --- OPTIMIZED LIST ROW (NEW) --- */
        .admin-list-row {
            display: flex; align-items: center;
            background: rgba(255,255,255,0.1); 
            border-bottom: 1px solid #444;
            padding: 8px 10px;
            border-radius: 5px;
        }
        .list-icon { 
            font-size: 20px; margin-right: 10px; min-width: 30px; text-align: center; 
        }
        .list-info { flex: 1; overflow: hidden; }
        .list-name { font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.9rem; }
        .list-meta { font-size: 0.7rem; color: #aaa; font-family: monospace; }

        /* Neu: Kleines Coverbild f√ºr die Liste */
        .list-img-small {
            width: 45px; height: 45px; 
            border-radius: 5px; 
            object-fit: cover; 
            margin-right: 10px;
            background: #333;
        }

        /* --- GRID CARD (OLD) --- */
        .admin-card {
            background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden;
            position: relative; border: 1px solid rgba(255,255,255,0.1);
            display: flex; flex-direction: column;
        }
        
        .admin-cover-wrap {
            width: 100%; aspect-ratio: 1/1; position: relative;
            background: #333; display: flex; align-items: center; justify-content: center;
        }
        .admin-cover-img { width: 100%; height: 100%; object-fit: cover; }
        
        .admin-card-body { padding: 10px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between;}
        .admin-card-title { font-size: 0.9em; font-weight: bold; margin-bottom: 5px; line-height: 1.2; }
        .admin-card-id { font-size: 0.7em; color: #aaa; margin-bottom: 8px; font-family: monospace; word-break: break-all;}
        
        .admin-actions {
            display: flex; gap: 5px; margin-top: auto;
        }
        .btn-mini {
            flex: 1; border: none; padding: 5px; border-radius: 4px; 
            font-size: 0.75em; cursor: pointer; color: white; font-weight: bold;
        }
        .btn-mini:disabled { opacity: 0.3; cursor: not-allowed; }
        .btn-mini.edit { background-color: #3498db; }
        .btn-mini.play { background-color: #2ecc71; }
        .btn-mini.vis { background-color: #f39c12; }
        .btn-mini.del { background-color: #e74c3c; flex: 0 0 30px; }

        .meta-details-container {
            background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px; margin-top: 10px;
            border-left: 3px solid #f1c40f;
        }
        .meta-row { display: flex; gap: 10px; }
        .meta-row input { flex: 1; }
        textarea.input-desc {
            width: 100%; height: 80px; padding: 10px; background: rgba(0,0,0,0.3);
            border: 1px solid #555; border-radius: 5px; color: white; font-family: sans-serif;
            resize: vertical;
        }

        #mode-switch-secret { position: fixed; top: 0; right: 0; width: 80px; height: 80px; z-index: 9999; }

        #status-msg {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.9); color: white; padding: 10px 20px;
            border-radius: 30px; display: none; z-index: 1000; text-align: center;
        }

        #flash-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(46, 204, 113, 0.5); pointer-events: none;
            opacity: 0; transition: opacity 0.2s; z-index: 2000;
        }

        .browser-warning {
            background-color: #ff4757; color: white; padding: 15px;
            border-radius: 10px; margin-bottom: 20px; display: none;
        }

        .hidden-container { display: none; }
        
        #stubborn-video {
            position: fixed; top: 0; left: 0; width: 1px; height: 1px; opacity: 0.01; pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="black-curtain"></div>
    
    <video id="stubborn-video" playsinline muted loop style="position:fixed; top:0; left:0; width:1px; height:1px; opacity:0.01; pointer-events:none;"></video>

    <div id="mode-switch-secret" onclick="handleSecretSwitch()"></div>
    
    <div id="flash-overlay"></div>

    <div id="parent-mode">
        <button class="btn-switch-kids" onclick="goToKidsMode()">‚ñ∂ ZUM KINDER-MODUS</button>
        <div class="hint-text">üí° Tipp: 5x oben rechts tippen f√ºr Admin-Men√º.</div>
        
        <div style="display:flex; justify-content:space-between; align-items:center;">
             <h1>üîß KlangKiste</h1>
             <button onclick="openStats()" style="background:none; border:2px solid #3498db; color:#3498db; padding:5px 10px; border-radius:15px; cursor:pointer; font-weight:bold;">üìä Statistik</button>
        </div>

        <div id="nfc-warning" class="browser-warning">‚ö†Ô∏è NFC API nicht verf√ºgbar. Bitte Chrome nutzen.</div>

        <div class="card">
            <h2>‚öôÔ∏è Einstellungen</h2>
            <label>Start-Modus:</label>
            <select id="start-mode-input" onchange="saveSettings()" style="background: rgba(46, 204, 113, 0.2); border: 1px solid #2ecc71;">
                <option value="parent">Eltern-Modus (Standard)</option>
                <option value="kids">Direkt Kinder-Modus</option>
            </select>

            <label>Maximale Lautst√§rke (Begrenzung):</label>
            <input type="range" id="max-vol-input" min="1" max="100" value="100" style="width:100%" oninput="updateSettingsUI()">
            <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 5px;">
                 <span id="vol-display" style="font-size: 0.9em; font-weight:bold;">100%</span>
                 
                 <button class="btn-admin" style="width: auto; margin:0; padding: 5px 15px; background-color: #fab1a0; color: #333; font-size: 0.8em;" onclick="playTestTone()">
                    üîä Test-Ton (Limit)
                 </button>
            </div>
            
            <div class="warn-text">
                ‚ö†Ô∏è Wichtig: Bitte stelle die Handy-Lautst√§rke (Hardware-Tasten) auf 100%.
            </div>
            
            <label>Schlaf-Timer:</label>
            <select id="sleep-timer-input" onchange="saveSettings()" style="margin-bottom: 15px;">
                <option value="0">Aus (Endlos)</option>
                <option value="10">10 Minuten</option>
                <option value="20">20 Minuten</option>
                <option value="30">30 Minuten</option>
                <option value="60">1 Stunde</option>
            </select>
        </div>

        <div class="card" style="border-left: 3px solid #0984e3;">
            <h2>üîã Energie & Display</h2>
            <div class="checkbox-wrapper">
                <input type="checkbox" id="check-wakelock" onchange="saveSettings()" checked>
                <div><strong>Display anlassen</strong><br><span style="font-size:0.8em; color:#ccc;">Nutzt Video-Trick + WakeLock</span></div>
            </div>
            <div class="checkbox-wrapper">
                <input type="checkbox" id="check-ecomode" onchange="updateEcoModeState(true)" checked>
                <div><strong>Stromsparen beim Umdrehen</strong><br><span style="font-size:0.8em; color:#ccc;">Display aus bei Face-down</span></div>
            </div>
            <button class="btn-admin" style="background-color: #74b9ff; font-size: 0.9em; margin-top:0;" onclick="requestIOSPermission()">
                üì± iOS Sensoren aktivieren
            </button>
        </div>

        <div class="card" style="border-left: 3px solid #e84393;">
            <h2>üé® Design f√ºr Kinder-Modus</h2>
            <div class="checkbox-wrapper">
                <input type="checkbox" id="check-enable-lib" onchange="saveSettings()" checked>
                <div><strong>üìö Bibliothek im Kinder-Modus erlauben</strong><br><span style="font-size:0.8em; color:#ccc;">Deaktivieren f√ºr reine Tag-Steuerung</span></div>
            </div>
            <div class="checkbox-wrapper">
                <input type="checkbox" id="check-colorful" onchange="saveSettings()" checked>
                <span><strong>üé® Bunte Kn√∂pfe f√ºr Kinder</strong></span>
            </div>
            
            <label>Hintergrund-Modus:</label>
            <select id="bg-mode-select" onchange="updateBgUIState(); saveSettings();" style="margin-bottom: 15px;">
                <option value="default">Standard</option>
                <option value="color">Farbe</option>
                <option value="image">Bild</option>
            </select>
            <div id="bg-color-container" class="hidden-container"> 
                 <input type="color" id="bg-color-input" value="#ffffff" onchange="saveSettings()">
            </div>
            <div id="bg-image-container" class="hidden-container">
                <button class="btn-admin" style="background-color: #6c5ce7; position:relative;">
                    üñºÔ∏è Bild hochladen...
                    <input type="file" id="bg-img-hidden" accept="image/*" onchange="saveBackgroundImage(this)">
                </button>
                <button class="btn-admin" style="background-color: #ff7675; margin-top:5px;" onclick="deleteBackgroundImage()">L√∂schen</button>
            </div>
        </div>
        
        <div class="card" style="border-left: 3px solid #9b59b6;">
            <h2>üìö Bibliothek & Inhalte</h2>
            <p style="font-size:0.85em; color:#ccc; margin-top:-10px; margin-bottom:15px;">Steuerung, was in der Bibliothek angezeigt wird.</p>

            <label>Alters-Filter (Global):</label>
            <div class="info-box-blue" style="margin-top:0; margin-bottom:10px;">
                Zeigt nur Inhalte bis zu diesem Alter.
            </div>
            <select id="lib-max-age-select" onchange="saveSettings()" style="margin-bottom: 15px;">
                <option value="99">Alle anzeigen (Kein Filter)</option>
                <option value="0">Nur "0 Jahre" / Ohne Altersangabe</option>
                <option value="1">Bis 1 Jahr</option>
                <option value="2">Bis 2 Jahre</option>
                <option value="3">Bis 3 Jahre</option>
                <option value="4">Bis 4 Jahre</option>
                <option value="5">Bis 5 Jahre</option>
                <option value="6">Bis 6 Jahre</option>
                <option value="8">Bis 8 Jahre</option>
                <option value="10">Bis 10 Jahre</option>
                <option value="12">Bis 12 Jahre</option>
            </select>
            
            <hr style="border-top:1px solid rgba(255,255,255,0.1); margin:15px 0;">
            
            <label>Massen-Steuerung:</label>
            <div class="btn-io-group">
                <button class="btn-admin" style="background-color: #2d3436; color:white; border: 1px solid #555;" onclick="setAllLibraryVisibility(true)">
                      üö´ Alle verstecken
                </button>
                <button class="btn-admin" style="background-color: #2ecc71; color:white;" onclick="setAllLibraryVisibility(false)">
                      üëÅÔ∏è Alle anzeigen
                </button>
            </div>
        </div>

        <div class="card" id="scan-card">
            <h2 id="form-title">üéµ Tag bearbeiten / anlernen</h2>
            
            <label>1. Audio & Quellen</label>
            <input type="file" id="audio-input" multiple accept="audio/*, .m4a, .mp3, .ogg, .wav, .flac" onchange="autoFillName()">
            <span id="audio-info" class="file-info"></span>
            
            <div style="display:flex; gap:10px;">
                <div style="flex:1; min-width: 0;"> <label style="font-size:0.8em;">Cue (Optional)</label>
                    <input type="file" id="cue-input" accept=".cue">
                    <span id="cue-info" class="file-info"></span>
                </div>
                <div style="flex:1; min-width: 0;"> <label style="font-size:0.8em;">Cover Bild</label>
                    <input type="file" id="img-input" accept="image/*">
                    <span id="img-info" class="file-info"></span>
                </div>
            </div>

            <label>2. Titel</label>
            <input type="text" id="track-name" placeholder="Name des H√∂rspiels...">
            
            <details>
                <summary style="cursor:pointer; color:#f1c40f; margin-bottom:10px; font-weight:bold;">üìù Erweiterte Infos (f√ºr Bibliothek)</summary>
                <div class="meta-details-container">
                    <label>Beschreibung (Inhalt):</label>
                    <textarea id="meta-desc" class="input-desc" placeholder="Worum geht es in der Geschichte?"></textarea>
                    
                    <div class="meta-row" style="margin-top:10px;">
                        <div>
                            <label>Alter (Jahre):</label>
                            <input type="number" id="meta-age" placeholder="z.B. 4" style="width:80px;">
                        </div>
                        <div style="flex:1;">
                            <label>Genre:</label>
                            <select id="meta-genre">
                                <option value="H√∂rspiel">H√∂rspiel</option>
                                <option value="Musik">Musik</option>
                                <option value="H√∂rbuch">H√∂rbuch</option>
                                <option value="Wissen">Wissen</option>
                            </select>
                        </div>
                        <div>
                            <label>Laufzeit (Min):</label>
                            <input type="number" id="meta-runtime" placeholder="auto" style="width:80px;">
                        </div>
                    </div>
                </div>
            </details>
            <br>
            
            <div class="checkbox-wrapper" style="background: rgba(231, 76, 60, 0.2); border: 1px solid #e74c3c;">
                <input type="checkbox" id="track-hidden-lib">
                <div><strong>üö´ In Bibliothek verstecken</strong><br><span style="font-size:0.8em; color:#ccc;">Taucht nicht im Kindermodus auf, aber per NFC abspielbar.</span></div>
            </div>
            <br>

            <div style="display:flex; gap:10px; flex-direction:column;">
                <button id="btn-save-tag" class="btn-admin" onclick="activateLinkMode()">üì° Tag scannen & speichern</button>
                <button id="btn-save-manual" class="btn-admin" style="background-color:#7f8c8d; margin-top:0;" onclick="saveManualTrack()">üíæ Ohne NFC speichern</button>
                <button id="btn-cancel-edit" class="btn-admin" style="background-color:#95a5a6; display:none;" onclick="cancelEdit()">Abbrechen</button>
            </div>
            <p id="scan-status" style="color: #74b9ff; margin-top: 10px; font-weight:bold; min-height: 20px;"></p>
        </div>

        <div class="card">
            <div class="admin-view-controls">
                <h2>üíæ Gespeicherte Tags (Admin)</h2>
                <div>
                    <button class="view-toggle-btn active" id="btn-view-list" onclick="setAdminView('list')">‚ò∞</button>
                    <button class="view-toggle-btn" id="btn-view-grid" onclick="setAdminView('grid')">‚ñ¶</button>
                </div>
            </div>
            <div id="tag-list-container" class="admin-list">
                </div>
        </div>

        <div class="card">
            <h2>üìÇ Datenbank</h2>
            
            <div class="info-box-blue">
                <strong>‚ÑπÔ∏è Bibliothek verkn√ºpfen:</strong><br>
                Dateien werden direkt vom Speicherort (z.B. SD-Karte) gestreamt und nicht kopiert.<br>
                ‚Ä¢ <strong>Unterordner:</strong> Werden als ganzes Album erkannt (inkl. Cover & JSON).<br>
                ‚Ä¢ <strong>Lose Dateien:</strong> Werden als einzelne H√∂rb√ºcher importiert.
            </div>

            <button class="btn-admin" style="background-color: #8e44ad; margin-bottom:10px; padding: 15px;" onclick="linkAudioLibrary()">
                üîó Bibliothek verbinden
            </button>

            <button class="btn-admin" style="background-color: #0984e3; margin-top:10px;" onclick="loadExamplesFromGitHub(event)">
                ‚òÅÔ∏è Beispiele direkt laden (Online)
            </button>
            
            <div class="btn-io-group">
                <button class="btn-admin btn-export" onclick="exportKlangkisteJson()">üì§ Datenbank exportieren</button>
                <button class="btn-admin btn-import">
                    üì• Datenbank laden
                    <input type="file" id="import-file-hidden" accept=".json" onchange="importKlangkisteJson(this)">
                </button>
            </div>
            
            <hr style="margin: 15px 0; border-top:1px solid #555;">
            <button class="btn-admin" style="background-color: #ff4757;" onclick="clearDatabase()">üóëÔ∏è Datenbank leeren</button>
        </div>

        <div class="footer-info">
            <p>KlangKiste NFC V77.4 (Final Fix)</p>
            <p>Entwickelt von <b>Sebastian R√∂√üer</b></p>
            <p>
                <a href="https://github.com/basecore/klangkiste/tree/main" target="_blank">GitHub Projekt</a> | 
                <a href="https://github.com/basecore/klangkiste/issues" target="_blank">Hilfe / Issues</a>
            </p>
        </div>
    </div>
    
    <div id="stats-modal">
        <div class="stats-header">
            <div class="stats-title">üìä Nutzung & Statistik</div>
            <button class="stats-close-btn" onclick="closeStats()">‚úï</button>
        </div>
        
        <div style="display:flex; gap:10px; margin-bottom:15px;">
             <button id="btn-stat-day" class="stats-toggle-btn active" onclick="loadStats('day')">Heute</button>
             <button id="btn-stat-week" class="stats-toggle-btn" onclick="loadStats('week')">7 Tage</button>
             <button id="btn-stat-all" class="stats-toggle-btn" onclick="loadStats('all')">Gesamt</button>
        </div>

        <div class="stat-card" style="display:flex; justify-content:space-around; text-align:center;">
            <div>
                <div class="stat-val-big" id="stat-total-time">0h</div>
                <div class="stat-label">H√∂rdauer</div>
            </div>
            <div>
                <div class="stat-val-big" id="stat-avg-session">0m</div>
                <div class="stat-label">√ò Session</div>
            </div>
        </div>

        <div class="stat-card">
             <div class="chart-row">
                 <div class="chart-label">Vollst√§ndig geh√∂rt ‚úÖ</div>
                 <div class="chart-val" id="stat-completed-count" style="width:auto; color:#2ecc71; font-weight:bold; font-size:1.2em;">0</div>
            </div>
        </div>

        <div class="stat-card">
             <div class="stat-label" style="margin-bottom:10px;">Lieblings-H√∂rspiele</div>
             <div id="stats-top-tracks"></div>
        </div>
        
        <div class="stat-card">
             <div class="stat-label" style="margin-bottom:10px;">Tageszeit (H√∂rverhalten)</div>
             <div id="stats-time-heatmap"></div>
        </div>
        
        <div class="stat-card">
             <div class="stats-title" style="font-size:1.1rem; margin-bottom:15px; border-bottom:1px solid #444; padding-bottom:5px;">
                üïí Exakte Timeline
             </div>
             <div id="stats-timeline-list" class="timeline-container">
             </div>
        </div>
    </div>

    <div id="kids-mode">
        <button id="btn-open-lib" onclick="openLibrary()">
            <svg viewBox="0 0 24 24" style="width:60%; height:60%; fill:white;"><path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9H9V9h10v2zm-4 4H9v-2h6v2zm4-8H9V5h10v2z"/></svg>
        </button>

        <div id="sleep-indicator">üåô <span id="sleep-countdown"></span></div>
        <div id="track-title-display" class="kids-text-shadow">Bereit zum Spielen!</div>
        <div id="playlist-info" class="kids-text-shadow"></div>
        
        <div id="album-art-container">
            <span id="album-placeholder">üéµ</span>
            <img id="album-img" src="" alt="Cover">
        </div>
        
        <div class="controls-main">
            <button id="btn-vol-down" class="btn-control btn-secondary" onclick="changeVolume(-0.1)">
                <svg viewBox="0 0 24 24"><path d="M19 13H5v-2h14v2z"/></svg>
            </button>
            <button id="btn-play-main" class="btn-control btn-play" onclick="togglePlay()">
                <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
            </button>
            <button id="btn-vol-up" class="btn-control btn-secondary" onclick="changeVolume(0.1)">
                <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
            </button>
        </div>

        <div id="volume-display-container">
            <div id="volume-bar"></div>
        </div>

        <div class="controls-nav-row">
             <button id="btn-reset" class="btn-control btn-secondary" onclick="restartPlaylist()" title="Reset">
                 <svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
             </button>
             
             <button id="btn-rewind" class="btn-control btn-secondary" onclick="skipBack()" title="-30s">
                 <svg viewBox="0 0 24 24"><path d="M11 18V6l-8.5 6 8.5 6zm9 0V6l-8.5 6 8.5 6z"/></svg>
             </button>

             <button id="btn-skip" class="btn-control btn-secondary" onclick="skipForward()" title="Skip">
                 <svg viewBox="0 0 24 24"><path d="M4 18l8.5-6L4 6v12zm9-12v12l8.5-6L13 6z"/></svg>
             </button>
             <button id="btn-next-track" class="btn-control btn-secondary" style="display:none;" onclick="skipToNextCueTrack()" title="Next Track/Chapter">
                 <svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
             </button>
        </div>

        <div id="time-container" onclick="toggleTimeDisplayMode()">
            <div id="time-progress"></div>
            <div id="time-text">--:--</div>
        </div>
    </div>

    <div id="library-mode">
        <div class="lib-header">
            <div class="lib-title">Meine KlangKiste üìö</div>
        </div>

        <div class="filter-scroll-container" id="lib-filters">
            <div class="filter-chip active" onclick="applyLibFilter('all', this)">Alle</div>
            <div class="filter-chip" onclick="applyLibFilter('recent', this)">Zuletzt geh√∂rt</div>
            </div>

        <div id="lib-content-area">
            </div>

        <button id="btn-close-lib" onclick="closeLibrary()">Zur√ºck zum Player</button>
    </div>

    <div id="lib-info-modal" onclick="closeAlbumInfo()">
        <div class="info-modal-content" onclick="event.stopPropagation()">
            <img id="info-modal-img" class="info-modal-cover" src="">
            <div id="info-modal-title" class="info-modal-h">Titel</div>
            <div id="info-modal-meta" class="info-modal-meta">Info</div>
            <div id="info-modal-desc" class="info-modal-desc">Beschreibung...</div>
            <button class="btn-close-modal" onclick="closeAlbumInfo()">Schlie√üen</button>
        </div>
    </div>

    <div id="status-msg"></div>
    <audio id="audio-player"></audio>

    <script>
        // --- HELFER (M√ºssen GANZ OBEN stehen!) ---
        function safeDisplay(id, val) { const el = document.getElementById(id); if(el) el.style.display = val; }
        function showStatus(msg) { 
            const el = document.getElementById('status-msg'); el.innerText = msg; el.style.display = 'block'; 
            setTimeout(() => { el.style.display = 'none'; }, 3000); 
        }
        function formatTime(s) { 
            if(isNaN(s) || !isFinite(s)) return "--:--";
            const minutes = Math.floor(s / 60); const seconds = Math.floor(s % 60); 
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`; 
        }

        // --- GLOBAL ---
        let db; let isParentMode = true; let ndef; let clickCount = 0; 
        let isProcessingDatabase = false; let adminListView = true;         
        let hiddenTracks = new Set(); 
        const audioPlayer = document.getElementById('audio-player');
        let wakeLock = null; let currentSessionStart = null; let currentAudioUrl = null; let saveInterval = null;
        let currentKidsVolumePct = 1.0; 
        let settings = { maxVolume: 1.0, sleepTimerMinutes: 0, colorfulControls: true, startMode: 'parent', bgMode: 'default', bgColor: '#ffffff', enableWakeLock: true, enableEcoMode: true, enableLibrary: true, hiddenIDs: [] };
        let sleepTimerId = null; let showRemainingTime = true; 
        let currentPlayingTagId = null; let currentTrackIndex = 0; let currentPlaylist = []; 
        let isNfcScanning = false; let isLinkModeActive = false;
        let currentCueTracks = null; let editingOriginalTagId = null;
        let currentLibFilter = 'all'; let activeCoverUrls = []; 

        const SYSTEM_BG_ID = "system_bg"; const SYSTEM_SETTINGS_ID = "system_settings"; 
        const DB_NAME = "MusicBoxDB_v15"; const DB_VERSION = 2;

        // --- INIT ---
        try { document.getElementById('library-mode').style.display = 'none'; } catch(e){}
        if (!("NDEFReader" in window)) safeDisplay('nfc-warning', 'block');
        loadSettings(); 

        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onupgradeneeded = function(event) {
            db = event.target.result;
            if (!db.objectStoreNames.contains("tracks")) { db.createObjectStore("tracks", { keyPath: "tagId" }); }
            if (!db.objectStoreNames.contains("stats_log")) {
                const statsStore = db.createObjectStore("stats_log", { keyPath: "id", autoIncrement: true });
                statsStore.createIndex("timestamp", "timestamp", { unique: false });
                statsStore.createIndex("type", "type", { unique: false });
            }
        };
        request.onsuccess = function(event) { 
             db = event.target.result; 
             loadTagList(); syncSettingsFromDB(); restoreLastSession();
        };


        // --- STATS LOGGING ---
        function logStatEvent(type, tagId = null, duration = 0, detailText = "") {
            if(!db) return;
            const tx = db.transaction(["stats_log"], "readwrite");
            const store = tx.objectStore("stats_log");
            store.add({ timestamp: Date.now(), type: type, tagId: tagId, durationSec: duration, details: detailText });
        }
        function endSessionLog() {
            if(currentSessionStart) {
                const duration = (Date.now() - currentSessionStart) / 1000;
                if(duration > 2) { logStatEvent('stop', currentPlayingTagId, duration, `Gespielt f√ºr ${Math.round(duration)}s`); }
                currentSessionStart = null;
            }
        }
        let volLogTimeout = null;
        audioPlayer.addEventListener('volumechange', () => {
            if(volLogTimeout) clearTimeout(volLogTimeout);
            volLogTimeout = setTimeout(() => {
                const p = Math.round(audioPlayer.volume * 100);
                if(p > 0) logStatEvent('volume', currentPlayingTagId, 0, `Auf ${p}% ge√§ndert`);
            }, 2000); 
        });
        function markTrackAsCompleted(tagId) {
            if(!tagId) return;
            const tx = db.transaction(["tracks"], "readwrite"); const store = tx.objectStore("tracks");
            store.get(tagId).onsuccess = (e) => {
                const track = e.target.result;
                if(track) {
                    track.completed = true; store.put(track);
                    showStatus("üéâ Alles angeh√∂rt!"); logStatEvent('completed', tagId, 0, "‚úÖ Fertig geh√∂rt");
                }
            };
        }

        // --- SETTINGS & DESIGN ---
        function updateBgUIState() {
            const mode = document.getElementById('bg-mode-select').value;
            safeDisplay('bg-color-container', mode === 'color' ? 'block' : 'none');
            safeDisplay('bg-image-container', mode === 'image' ? 'block' : 'none');
        }
        function saveBackgroundImage(input) {
            const file = input.files[0]; if(!file) return;
            const tx = db.transaction(["tracks"], "readwrite"); const store = tx.objectStore("tracks");
            store.put({tagId: SYSTEM_BG_ID, name: "System Background", imageBlob: file});
            tx.oncomplete = () => { showStatus("Hintergrund gespeichert üñºÔ∏è"); input.value = ""; applyKidsDesign(); };
        }
        function deleteBackgroundImage() {
            const tx = db.transaction(["tracks"], "readwrite"); const store = tx.objectStore("tracks");
            store.delete(SYSTEM_BG_ID); tx.oncomplete = () => { showStatus("Gel√∂scht"); applyKidsDesign(); };
        }
        function applyKidsDesign() {
            try {
                const kidsDiv = document.getElementById('kids-mode');
                const mode = settings.bgMode || 'default';
                kidsDiv.style.backgroundImage = ''; kidsDiv.style.backgroundColor = '';
                if (mode === 'default') { kidsDiv.style.backgroundImage = "url('assets/img/hintergrund.jpg')"; kidsDiv.style.backgroundColor = "#2c3e50"; } 
                else if (mode === 'color') { kidsDiv.style.backgroundColor = settings.bgColor || '#ffffff'; }
                else if (mode === 'image') { 
                    if(!db) return;
                    const store = db.transaction(["tracks"], "readonly").objectStore("tracks");
                    const req = store.get(SYSTEM_BG_ID);
                    req.onsuccess = () => {
                        if(req.result && req.result.imageBlob) { const url = URL.createObjectURL(req.result.imageBlob); kidsDiv.style.backgroundImage = `url('${url}')`; } 
                        else { kidsDiv.style.backgroundImage = "url('assets/img/hintergrund.jpg')"; }
                    };
                }
            } catch(e) {}
        }
        function syncSettingsFromDB() {
            const store = db.transaction(["tracks"], "readonly").objectStore("tracks");
            const req = store.get(SYSTEM_SETTINGS_ID);
            req.onsuccess = () => {
                if(req.result && req.result.data) {
                    settings = req.result.data; updateUIFromSettings();
                    if(settings.hiddenIDs && Array.isArray(settings.hiddenIDs)) { hiddenTracks = new Set(settings.hiddenIDs); }
                    if (settings.startMode === 'kids') { setTimeout(() => { goToKidsMode(); }, 100); }
                } else { saveSettings(); }
            };
        }
        function updateUIFromSettings() {
            document.getElementById('max-vol-input').value = settings.maxVolume * 100; 
            document.getElementById('vol-display').innerText = Math.round(settings.maxVolume * 100) + "%"; 
            document.getElementById('sleep-timer-input').value = settings.sleepTimerMinutes;
            document.getElementById('check-colorful').checked = settings.colorfulControls;
            document.getElementById('start-mode-input').value = settings.startMode || 'parent';
            document.getElementById('bg-mode-select').value = settings.bgMode || 'default';
            document.getElementById('bg-color-input').value = settings.bgColor || '#ffffff';
            document.getElementById('check-wakelock').checked = settings.enableWakeLock || false;
            document.getElementById('check-ecomode').checked = settings.enableEcoMode || false;
            document.getElementById('check-enable-lib').checked = settings.enableLibrary !== false; 
            document.getElementById('lib-max-age-select').value = settings.libMaxAge !== undefined ? settings.libMaxAge : "99";
            updateBgUIState(); 
        }
        function saveSettings() {
            settings.maxVolume = document.getElementById('max-vol-input').value / 100;
            applyActualVolume(); 
            settings.sleepTimerMinutes = parseInt(document.getElementById('sleep-timer-input').value);
            settings.colorfulControls = document.getElementById('check-colorful').checked;
            settings.startMode = document.getElementById('start-mode-input').value;
            settings.bgMode = document.getElementById('bg-mode-select').value;
            settings.bgColor = document.getElementById('bg-color-input').value;
            settings.enableWakeLock = document.getElementById('check-wakelock').checked;
            settings.enableEcoMode = document.getElementById('check-ecomode').checked;
            settings.enableLibrary = document.getElementById('check-enable-lib').checked;
            settings.libMaxAge = parseInt(document.getElementById('lib-max-age-select').value);
            settings.hiddenIDs = Array.from(hiddenTracks);
            localStorage.setItem('klangkisteSettings_v16', JSON.stringify(settings));
            if(db) { const tx = db.transaction(["tracks"], "readwrite"); tx.objectStore("tracks").put({ tagId: SYSTEM_SETTINGS_ID, name: "System Settings", data: settings }); }
        }
        function loadSettings() {
            const saved = localStorage.getItem('klangkisteSettings_v16');
            if (saved) { settings = JSON.parse(saved); if(settings.hiddenIDs) hiddenTracks = new Set(settings.hiddenIDs); }
            updateUIFromSettings(); 
        }
        function updateSettingsUI() { document.getElementById('vol-display').innerText = document.getElementById('max-vol-input').value + "%"; saveSettings(); }
        function applyActualVolume() { audioPlayer.volume = Math.pow(currentKidsVolumePct * settings.maxVolume, 2); }
        function changeVolume(change) { currentKidsVolumePct += change; if(currentKidsVolumePct > 1.0) currentKidsVolumePct = 1.0; if(currentKidsVolumePct < 0.0) currentKidsVolumePct = 0.0; applyActualVolume(); updateVolumeUI(); }
        function updateVolumeUI() {
            let pct = currentKidsVolumePct * 100; const bar = document.getElementById('volume-bar'); bar.style.width = pct + "%";
            if(pct < 40) bar.style.backgroundColor = "var(--green-safe)"; else if (pct < 75) bar.style.backgroundColor = "var(--orange-warn)"; else bar.style.backgroundColor = "var(--red-danger)";
        }

        // --- AUDIO ENGINE ---
        function playTestTone() {
            const testAudio = new Audio('assets/limit.mp3'); testAudio.volume = Math.pow(settings.maxVolume, 2);
            testAudio.onerror = () => { showStatus("Backup-Ton üö®"); playBackupTone(testAudio.volume); };
            testAudio.play().then(() => showStatus("üîä Test-Ton")).catch(() => playBackupTone(testAudio.volume));
        }
        function playBackupTone(volume) {
            try {
                const AC = window.AudioContext || window.webkitAudioContext; if(!AC) return;
                const ctx = new AC(); const osc = ctx.createOscillator(); const gain = ctx.createGain();
                osc.type = 'sine'; osc.frequency.setValueAtTime(440, ctx.currentTime); gain.gain.setValueAtTime(volume, ctx.currentTime);
                osc.connect(gain); gain.connect(ctx.destination); osc.start(); 
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+1); osc.stop(ctx.currentTime+1);
            } catch(e){}
        }

        // --- HARDWARE ---
        const stubbornVideo = document.getElementById('stubborn-video');
        stubbornVideo.src = "data:video/mp4;base64,AAAAHGZ0eXBNNEVAAAAAAAEAAQAAAAAAAAAAAAAA1W1vb3YAAABsbXZoAAAAAQAAAAAA5G0AAORtAAABAAABAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAAAGGlvZHMAAAAAEICAgAcAT////3//AAACQXRyYWsAAABcdGtoZAAAAAEAAAAAAAAAAAAAAQAAAAEAAAAAAORtAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAAkZWR0cwAAABxlbHN0AAAAAAAAAAEAAADkbQAAAAABAAAAAAABM21kaWEAAAAgbWRoZAAAAAEAAAAAAORtAADkbQAAQBAAABExAAAAAAAAAAA5aGRscgAAAAAAAAAAdmlkZQAAAAAAAAAAAAAAAFZpZGVvSGFuZGxlcgAAAAABAAAADG1pbmYAAAAUdm1oZAAAAAEAAAAAAAAAAAAAACRkaW5mAAAAHGRyZWYAAAAAAAAAAQAAAAx1cmwgAAAAAQAAAKFzdGJsAAAAp3N0ZHNkAAAAAAAAAAEAAABnYXZjMQAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAQAAAAEAAABIAAAASAAAAAAADqAAAAAAAP//AAAALWF2Y0MBAAAALgEASAAAAAb/gAQACAAAAAAhAAACigAAlzYBAAAAAwEBAAAAAwEBAAAAAGhzdHRzAAAAAAAAAAEAAAABAAABAAAAABxzdHNjAAAAAAAAAAEAAAABAAAAAQAAAAEAAAAwc3RzegAAAAAAAAAAAAAAAQAAABRzdGNvAAAAAAAAAAEAAACwAAAAYXVkdGEAAAAUY29wcmQAAAAAQmFzZWNvcmU=";
        stubbornVideo.addEventListener('pause', () => { if(settings.enableWakeLock && !isParentMode && !audioPlayer.paused) stubbornVideo.play().catch(()=>{}); });

        async function requestWakeLock() {
            if(!settings.enableWakeLock) return;
            if('wakeLock' in navigator) { try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e){} }
            stubbornVideo.play().catch(()=>{});
        }
        async function releaseWakeLock() { if(wakeLock) { await wakeLock.release(); wakeLock=null; } stubbornVideo.pause(); }
        
        document.addEventListener('visibilitychange', () => { if(document.visibilityState === 'visible' && settings.enableWakeLock && !isParentMode) requestWakeLock(); if(document.visibilityState === 'hidden') forceSaveCurrentPosition(); });
        window.addEventListener('beforeunload', () => { forceSaveCurrentPosition(); endSessionLog(); });
        
        function updateEcoModeState(chk) { 
            const active = document.getElementById('check-ecomode').checked; 
            const curtain = document.getElementById('black-curtain');
            if(active) { window.addEventListener('deviceorientation', handleOrientation); if(chk) showStatus("Sensoren an ‚úÖ"); } 
            else { window.removeEventListener('deviceorientation', handleOrientation); curtain.style.display='none'; if(chk) showStatus("Sensoren aus"); }
            if(chk) saveSettings();
        }
        function handleOrientation(e) { 
            const beta = e.beta; if(beta===null) return; 
            const curtain = document.getElementById('black-curtain');
            if(beta > 140 || beta < -140) { if(curtain.style.display!=='block') { curtain.style.display='block'; logStatEvent('eco_flip'); } } 
            else if(curtain.style.display==='block') curtain.style.display='none';
        }
        function requestIOSPermission() { 
            if(typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission().then(r => { if(r==='granted') { alert("OK"); document.getElementById('check-ecomode').checked=true; updateEcoModeState(true); } else alert("Blockiert"); });
            } else alert("Nicht n√∂tig/m√∂glich");
        }

        async function startNFC() {
            if(isNfcScanning) return; if("NDEFReader" in window) {
                try { ndef = new NDEFReader(); await ndef.scan(); isNfcScanning = true; showStatus("Scanner bereit"); 
                    ndef.onreading = e => { 
                        document.getElementById('flash-overlay').style.opacity = "1"; setTimeout(()=>document.getElementById('flash-overlay').style.opacity="0", 200);
                        if(isParentMode) { if(isLinkModeActive) { saveTrackLink(e.serialNumber); isLinkModeActive=false; } else showStatus("Tag: "+e.serialNumber); } 
                        else { logStatEvent('scan', null, 0, e.serialNumber); playTrackByTag(e.serialNumber); }
                    };
                } catch(e){ console.log(e); isNfcScanning=false; }
            }
        }

        // --- PLAYBACK CORE ---
        function playTrackByTag(tagId) {
            if(currentPlayingTagId === tagId) { 
                if(audioPlayer.paused) togglePlay(); else showStatus("L√§uft bereits"); 
                return; 
            }
            endSessionLog(); 
            if(currentPlayingTagId) forceSaveCurrentPosition();
            
            const store = db.transaction(["tracks"], "readwrite").objectStore("tracks");
            store.get(tagId).onsuccess = (e) => {
                const track = e.target.result;
                if(track) {
                    logStatEvent('play', tagId, 0, "Start");
                    localStorage.setItem('lastActiveTagId', tagId);
                    track.lastPlayedTimestamp = Date.now(); store.put(track);
                    
                    if(!track.playlist || track.playlist.length === 0) { showStatus("‚ö†Ô∏è Leer!"); return; }
                    
                    document.getElementById('track-title-display').innerText = track.name;
                    const imgEl = document.getElementById('album-img'); const ph = document.getElementById('album-placeholder');
                    if(track.imageBlob) { imgEl.src = URL.createObjectURL(track.imageBlob); imgEl.style.display='block'; ph.style.display='none'; }
                    else { imgEl.style.display='none'; ph.style.display='block'; }
                    
                    currentPlayingTagId = tagId; currentPlaylist = track.playlist; currentCueTracks = track.cueTracks;
                    document.getElementById('btn-next-track').style.display = (currentCueTracks || currentPlaylist.length > 1) ? 'flex' : 'none';
                    
                    let idx = track.lastTrackIndex || 0; if(idx >= currentPlaylist.length) idx = 0;
                    playPlaylistIndex(idx, track.lastTime || 0);
                    if(isParentMode) goToKidsMode();
                } else showStatus("Tag unbekannt");
            };
        }

        async function playPlaylistIndex(index, startTime=0) {
            if(index >= currentPlaylist.length) return;
            if(currentAudioUrl) { URL.revokeObjectURL(currentAudioUrl); currentAudioUrl = null; }
            
            currentTrackIndex = index;
            let item = currentPlaylist[index];
            let playFile = null;

            showStatus("Lade Audio...");

            try {
                if(item.kind === 'file' && typeof item.getFile === 'function') {
                    // Link Mode: Permission Check
                    const opts = {mode:'read'};
                    if((await item.queryPermission(opts))!=='granted') {
                        if((await item.requestPermission(opts))!=='granted') { showStatus("‚ùå Zugriff fehlt"); return; }
                    }
                    playFile = await item.getFile();
                } else { playFile = item; } // Normal File

                currentAudioUrl = URL.createObjectURL(playFile);
                updateInfoText();
                audioPlayer.src = currentAudioUrl;
                
                audioPlayer.onloadedmetadata = () => {
                    if(startTime > 0 && startTime < audioPlayer.duration-2) audioPlayer.currentTime = startTime;
                    applyActualVolume(); updateVolumeUI();
                    audioPlayer.play().then(() => {
                        setPlayButtonState(true); startSleepTimer(); requestWakeLock(); currentSessionStart = Date.now();
                        if(saveInterval) clearInterval(saveInterval); saveInterval = setInterval(forceSaveCurrentPosition, 5000);
                        updateTimeDisplay();
                    }).catch(err => { console.error(err); showStatus("Start blockiert (Tippe Play)"); });
                };
            } catch(e) { console.error(e); showStatus("Fehler beim Laden"); }
        }

        function restoreLastSession() {
            const lastId = localStorage.getItem('lastActiveTagId');
            if(lastId) {
                const store = db.transaction(["tracks"], "readonly").objectStore("tracks");
                store.get(lastId).onsuccess = (e) => {
                    const t = e.target.result;
                    if(t) {
                        document.getElementById('track-title-display').innerText = t.name;
                        currentPlayingTagId = t.tagId; currentPlaylist = t.playlist; currentCueTracks = t.cueTracks;
                        const imgEl = document.getElementById('album-img');
                        if(t.imageBlob) { imgEl.src = URL.createObjectURL(t.imageBlob); imgEl.style.display='block'; document.getElementById('album-placeholder').style.display='none'; }
                        document.getElementById('btn-next-track').style.display = (currentCueTracks || currentPlaylist.length > 1) ? 'flex' : 'none';
                        currentTrackIndex = t.lastTrackIndex || 0;
                        updateInfoText();
                        showStatus("Bereit");
                    }
                };
            }
        }

        function togglePlay() {
            if(audioPlayer.paused) { 
                if(audioPlayer.src) { audioPlayer.play(); setPlayButtonState(true); startSleepTimer(); requestWakeLock(); currentSessionStart = Date.now(); }
                else showStatus("Kein Track");
            } else {
                audioPlayer.pause(); setPlayButtonState(false); stopSleepTimer(); releaseWakeLock(); forceSaveCurrentPosition(); endSessionLog();
            }
        }
        
        function setPlayButtonState(isPlaying) {
            const btn = document.getElementById('btn-play-main');
            if(isPlaying) { btn.style.backgroundColor = "var(--red-danger)"; btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>'; }
            else { btn.style.backgroundColor = "var(--green-safe)"; btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>'; }
        }

        function skipForward() { if(audioPlayer.src) { audioPlayer.currentTime += 30; showStatus("‚è© +30s"); } }
        function skipBack() { if(audioPlayer.src) { audioPlayer.currentTime -= 30; showStatus("‚è™ -30s"); } }
        function restartPlaylist() { if(currentPlayingTagId) playPlaylistIndex(0,0); }
        
        function skipToNextCueTrack() {
            if(currentCueTracks && audioPlayer.src) {
                const next = currentCueTracks.find(t => t.time > (audioPlayer.currentTime + 2));
                if(next) { audioPlayer.currentTime = next.time; showStatus("‚è© " + next.title); } else showStatus("Ende");
            } else if(currentPlaylist.length > 1) {
                if(currentTrackIndex+1 < currentPlaylist.length) { playPlaylistIndex(currentTrackIndex+1); showStatus("‚è≠Ô∏è Track"); } else showStatus("Ende");
            }
        }

        function forceSaveCurrentPosition() {
            if(!currentPlayingTagId) return;
            localStorage.setItem('lastActiveTagId', currentPlayingTagId);
            const store = db.transaction(["tracks"], "readwrite").objectStore("tracks");
            const getReq = store.get(currentPlayingTagId);
            getReq.onsuccess = () => {
                const r = getReq.result; 
                if(r) { r.lastTrackIndex = currentTrackIndex; r.lastTime = audioPlayer.currentTime; store.put(r); }
            };
        }

        function startSleepTimer() {
            if(sleepTimerId) clearTimeout(sleepTimerId); 
            const min = settings.sleepTimerMinutes;
            if(min > 0) {
                document.getElementById('sleep-indicator').style.display = 'block'; document.getElementById('sleep-countdown').innerText = min+"m";
                sleepTimerId = setTimeout(()=>{
                    let vol = audioPlayer.volume;
                    const fade = setInterval(()=>{
                        if(vol > 0.05) { vol -= 0.05; audioPlayer.volume = vol; } 
                        else { clearInterval(fade); togglePlay(); applyActualVolume(); showStatus("Schlafmodus"); }
                    }, 200);
                }, min*60000);
            } else document.getElementById('sleep-indicator').style.display = 'none';
        }
        function stopSleepTimer() { if(sleepTimerId) clearTimeout(sleepTimerId); document.getElementById('sleep-indicator').style.display='none'; }

        audioPlayer.addEventListener('timeupdate', updateTimeDisplay);
        function updateTimeDisplay() {
            if(!audioPlayer.duration) return;
            const cur = audioPlayer.currentTime; const dur = audioPlayer.duration;
            document.getElementById('time-progress').style.width = (cur/dur)*100 + "%";
            document.getElementById('time-text').innerText = showRemainingTime ? "-"+formatTime(dur-cur) : formatTime(cur);
            if(currentCueTracks) {
                const ch = currentCueTracks.slice().reverse().find(t => cur >= t.time);
                if(ch) document.getElementById('playlist-info').innerText = ch.title;
            }
        }
        function toggleTimeDisplayMode() { showRemainingTime = !showRemainingTime; updateTimeDisplay(); }

        // --- IMPORT LOGIC (FIXED) ---
        async function linkAudioLibrary() {
            if (!window.showDirectoryPicker) { alert("Bitte Chrome nutzen."); return; }
            try {
                const dirHandle = await window.showDirectoryPicker();
                showStatus("Scanne Ordner...");
                const groups = {}; let count = 0;

                async function scanDirectory(directoryHandle, pathName) {
                    // Schritt 1: JSON & CUE scannen
                    let metaData = null;
                    let cueData = null;

                    for await (const entry of directoryHandle.values()) {
                        if(entry.kind === 'file') {
                            const lname = entry.name.toLowerCase();
                            if(lname === 'klangkiste.json') {
                                try { const f = await entry.getFile(); const text = await f.text(); metaData = JSON.parse(text); } catch(e){}
                            } else if (lname.endsWith('.cue')) {
                                try { const f = await entry.getFile(); const text = await f.text(); cueData = parseCueSheet(text); } catch(e){}
                            }
                        }
                    }

                    // Schritt 2: Dateien verarbeiten
                    for await (const entry of directoryHandle.values()) {
                        if (entry.kind === 'file') {
                            const ext = entry.name.split('.').pop().toLowerCase();
                            if (['mp3', 'm4a', 'ogg', 'wav', 'flac'].includes(ext)) {
                                let groupName = pathName;
                                let isRootFile = false;
                                if (!groupName) { groupName = entry.name.replace(/\.[^/.]+$/, ""); isRootFile = true; }
                                
                                if (!groups[groupName]) { groups[groupName] = { audio: [], img: null, name: groupName, meta: {}, cue: null }; }
                                groups[groupName].audio.push(entry); 
                                
                                if(cueData) groups[groupName].cue = cueData;

                                if(metaData && Array.isArray(metaData)) {
                                    const match = metaData.find(m => m.playlistFileNames && m.playlistFileNames.includes(entry.name));
                                    if(match && match.meta) groups[groupName].meta = match.meta;
                                }
                            }
                            else if (['jpg', 'jpeg', 'png', 'webp'].includes(ext)) {
                                const groupName = pathName;
                                if (groupName) { 
                                     if (!groups[groupName]) groups[groupName] = { audio: [], img: null, name: groupName, meta:{}, cue: null };
                                     // BILDER ALS BLOB SPEICHERN (FIX!)
                                     const fileData = await entry.getFile();
                                     groups[groupName].img = fileData; 
                                }
                            }
                        } else if (entry.kind === 'directory') {
                            await scanDirectory(entry, entry.name); 
                        }
                    }
                }

                await scanDirectory(dirHandle, "");
                const groupKeys = Object.keys(groups);
                if(groupKeys.length === 0) { alert("Keine Audio-Dateien gefunden."); return; }

                for (let i = 0; i < groupKeys.length; i++) {
                    const g = groups[groupKeys[i]];
                    if (g.audio.length === 0) continue;
                    g.audio.sort((a, b) => a.name.localeCompare(b.name, undefined, {numeric: true, sensitivity: 'base'}));
                    
                    const record = {
                        tagId: "link_" + Date.now() + "_" + Math.random().toString(36).substr(2, 5),
                        name: g.name.replace(/_/g, ' '),
                        playlist: g.audio,
                        playlistFileNames: g.audio.map(h => h.name),
                        imageBlob: g.img,
                        imageFileName: g.img ? g.img.name : null,
                        meta: g.meta || {},
                        cueTracks: g.cue || null, // CUE FIX
                        lastTrackIndex: 0, lastTime: 0, isLinked: true 
                    };

                    const tx = db.transaction(["tracks"], "readwrite");
                    tx.objectStore("tracks").put(record);
                    await new Promise(resolve => tx.oncomplete = resolve);
                    count++;
                    showStatus(`Verkn√ºpft: ${g.name}`);
                }
                showStatus(`${count} H√∂rb√ºcher verkn√ºpft! üéâ`); loadTagList();
            } catch (e) { console.error(e); alert("Abbruch/Fehler: " + e.message); }
        }

        async function loadExamplesFromGitHub(event) {
            if(event) { event.stopPropagation(); event.preventDefault(); }
            if(!confirm("Beispiele laden?")) return;
            showStatus("‚è≥ Lade Daten...");
            try {
                const jsonResp = await fetch("https://raw.githubusercontent.com/basecore/klangkiste/main/example/klangkiste.json");
                if (!jsonResp.ok) throw new Error("JSON nicht gefunden");
                const data = await jsonResp.json();
                const preparedEntries = [];
                for (const entry of data) {
                    showStatus(`üì• Lade: ${entry.name.substring(0, 15)}...`);
                    const audioBlobs = [];
                    if (entry.playlistFileNames) {
                        for (const fileName of entry.playlistFileNames) {
                            const resp = await fetch("https://raw.githubusercontent.com/basecore/klangkiste/main/example/" + encodeURIComponent(fileName));
                            if (resp.ok) { const blob = await resp.blob(); audioBlobs.push(new File([blob], fileName, { type: "audio/mp3" })); }
                        }
                    }
                    if (audioBlobs.length === 0) continue;
                    let imageBlob = null;
                    if (entry.imageFileName) {
                        const resp = await fetch("https://raw.githubusercontent.com/basecore/klangkiste/main/example/" + encodeURIComponent(entry.imageFileName));
                        if (resp.ok) { const blob = await resp.blob(); imageBlob = new File([blob], entry.imageFileName, { type: "image/png" }); }
                    }
                    preparedEntries.push({
                        tagId: entry.tagId, name: entry.name, playlist: audioBlobs,
                        playlistFileNames: entry.playlistFileNames, imageBlob: imageBlob, imageFileName: entry.imageFileName,
                        meta: entry.meta || {}, tags: entry.tags || [], filter_age: entry.filter_age || 0,
                        lastTrackIndex: 0, lastTime: 0, completed: false
                    });
                }
                const tx = db.transaction(["tracks"], "readwrite"); const store = tx.objectStore("tracks");
                preparedEntries.forEach(item => { store.put(item); });
                tx.oncomplete = () => { showStatus("‚úÖ Fertig!"); loadTagList(); alert(`Erfolg! ${preparedEntries.length} H√∂rspiele installiert.`); };
            } catch (e) { alert("Download Fehler: " + e.message); showStatus("Fehler ‚ùå"); }
        }

        async function importKlangkisteJson(input) {
            const file = input.files[0]; if(!file) return; 
            showStatus("Analysiere Backup...");
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const rawData = JSON.parse(e.target.result);
                    let tracksToImport = [], statsToImport = [], settingsToImport = null;
                    if (rawData.type && rawData.type.startsWith("FULL_BACKUP")) {
                        tracksToImport = rawData.tracks || []; statsToImport = rawData.stats || []; settingsToImport = rawData.systemSettings || null;
                    } else if (Array.isArray(rawData)) { tracksToImport = rawData; }

                    if(!confirm(`Backup einspielen?\n\n‚Ä¢ ${tracksToImport.length} H√∂rb√ºcher\n‚Ä¢ ${statsToImport.length} Statistik-Eintr√§ge`)) return;

                    const tx = db.transaction(["tracks", "stats_log"], "readwrite");
                    const trackStore = tx.objectStore("tracks"); const statsStore = tx.objectStore("stats_log");

                    if (settingsToImport) {
                        localStorage.setItem('klangkisteSettings_v16', JSON.stringify(settingsToImport));
                        trackStore.put({ tagId: SYSTEM_SETTINGS_ID, name: "System Settings", data: settingsToImport });
                        settings = settingsToImport;
                        if(settings.hiddenIDs) hiddenTracks = new Set(settings.hiddenIDs);
                        updateUIFromSettings();
                    }
                    if (statsToImport.length > 0) { statsToImport.forEach(stat => { statsStore.put(stat); }); }

                    for(const entry of tracksToImport) {
                          await new Promise((resolve) => {
                            const req = trackStore.get(entry.tagId);
                            req.onsuccess = () => {
                                const existing = req.result;
                                const newRecord = {
                                    tagId: entry.tagId, name: entry.name, playlistFileNames: entry.playlistFileNames,
                                    imageFileName: entry.imageFileName, meta: entry.meta, tags: entry.tags, filter_age: entry.filter_age,
                                    lastTrackIndex: entry.lastTrackIndex || 0, lastTime: entry.lastTime || 0,
                                    completed: entry.completed || false, hiddenInLib: entry.hiddenInLib || false,
                                    lastPlayedTimestamp: entry.lastPlayedTimestamp || 0,
                                    playlist: existing ? existing.playlist : [], // Behalte Audio
                                    imageBlob: existing ? existing.imageBlob : null,
                                    cueTracks: existing ? existing.cueTracks : null 
                                };
                                trackStore.put(newRecord);
                                resolve();
                            };
                          });
                    }
                    tx.oncomplete = () => { alert("Wiederherstellung komplett!"); loadTagList(); input.value = ""; };
                } catch(e) { alert("Fehler: " + e.message); }
            }; 
            reader.readAsText(file);
        }

        // --- EXPORT ---
        async function exportKlangkisteJson() {
            showStatus("Erstelle Backup...");
            const tx = db.transaction(["tracks", "stats_log"], "readonly");
            const trackStore = tx.objectStore("tracks"); const statsStore = tx.objectStore("stats_log");
            
            const [tracks, stats] = await new Promise((resolve) => {
                let t = null, s = null, c = 0;
                const check = () => { c++; if(c===2) resolve([t,s]); };
                trackStore.getAll().onsuccess = e => { t = e.target.result; check(); };
                statsStore.getAll().onsuccess = e => { s = e.target.result; check(); };
            });

            const exportData = { type: "FULL_BACKUP_V1", timestamp: Date.now(), systemSettings: {}, tracks: [], stats: stats || [] };

            tracks.forEach(t => {
                if (t.tagId === SYSTEM_SETTINGS_ID) exportData.systemSettings = t.data;
                else if (t.tagId !== SYSTEM_BG_ID) {
                    exportData.tracks.push({
                        tagId: t.tagId, name: t.name, playlistFileNames: t.playlistFileNames || [],
                        imageFileName: t.imageFileName || null, meta: t.meta || {}, tags: t.tags || [],
                        filter_age: t.filter_age || 0, lastTrackIndex: t.lastTrackIndex || 0, lastTime: t.lastTime || 0,
                        completed: t.completed || false, hiddenInLib: t.hiddenInLib || false,
                        lastPlayedTimestamp: t.lastPlayedTimestamp || 0
                    });
                }
            });

            const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: "application/json"});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = `klangkiste_backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            showStatus("Backup erstellt! ‚úÖ");
        }

        function saveManualTrack() {
            const n = document.getElementById('track-name').value;
            const hasAudio = document.getElementById('audio-input').files.length > 0;
            if(!editingOriginalTagId && !hasAudio) { alert("Bitte Audio w√§hlen!"); return; }
            if(n === "") { alert("Bitte Name eingeben!"); return; }
            const targetId = editingOriginalTagId ? editingOriginalTagId : "manual_" + Date.now();
            saveTrackLink(targetId);
        }
        
        function saveTrackLink(tagId) {
            const audioInput = document.getElementById('audio-input');
            const imgInput = document.getElementById('img-input');
            const cueInput = document.getElementById('cue-input');
            const name = document.getElementById('track-name').value;
            
            const metaObj = {
                description: document.getElementById('meta-desc').value,
                age_recommendation: document.getElementById('meta-age').value,
                genre: document.getElementById('meta-genre').value,
                runtime: document.getElementById('meta-runtime').value
            };
            const isHidden = document.getElementById('track-hidden-lib').checked;

            const finalize = (oldRecord, newCue) => {
                let finalAudio = audioInput.files.length > 0 ? Array.from(audioInput.files) : (oldRecord ? oldRecord.playlist : []);
                let finalImg = imgInput.files.length > 0 ? imgInput.files[0] : (oldRecord ? oldRecord.imageBlob : null);
                
                const record = { 
                    tagId: tagId, name: name, playlist: finalAudio, 
                    playlistFileNames: finalAudio.map(f=>f.name), imageBlob: finalImg, 
                    cueTracks: newCue || (oldRecord ? oldRecord.cueTracks : null),
                    meta: metaObj, hiddenInLib: isHidden,
                    lastTrackIndex: oldRecord ? oldRecord.lastTrackIndex : 0, lastTime: oldRecord ? oldRecord.lastTime : 0 
                };
                const tx = db.transaction(["tracks"], "readwrite"); tx.objectStore("tracks").put(record);
                tx.oncomplete = () => { if(isHidden) hiddenTracks.add(tagId); else hiddenTracks.delete(tagId); saveSettings(); cancelEdit(); loadTagList(); showStatus("Gespeichert!"); };
            };

            const cueFile = cueInput.files[0];
            const processCueAndSave = (oldRecord) => {
                if(cueFile) {
                    const reader = new FileReader(); reader.onload = (e) => { const parsedTracks = parseCueSheet(e.target.result); finalize(oldRecord, parsedTracks); }; reader.readAsText(cueFile);
                } else { finalize(oldRecord, null); }
            };

            if (editingOriginalTagId) {
                const store = db.transaction(["tracks"], "readonly").objectStore("tracks");
                store.get(editingOriginalTagId).onsuccess = (e) => { processCueAndSave(e.target.result); };
            } else {
                if(audioInput.files.length === 0) { alert("Kein Audio!"); return; }
                processCueAndSave(null);
            }
        }

        function activateLinkMode() {
            const n = document.getElementById('track-name').value;
            const hasAudio = document.getElementById('audio-input').files.length > 0;
            if(!editingOriginalTagId && !hasAudio) { alert("Bitte Audio w√§hlen!"); return; }
            if(n === "") { alert("Bitte Name eingeben!"); return; }
            isLinkModeActive = true; document.getElementById('scan-status').innerText = ">>> FIGUR JETZT AUFLEGEN <<<";
            if (!isNfcScanning) startNFC();
        }

        function loadTagForEdit(id) {
            const store = db.transaction(["tracks"], "readonly").objectStore("tracks");
            store.get(id).onsuccess = (e) => {
                const r = e.target.result;
                if(r) {
                    editingOriginalTagId = id;
                    document.getElementById('track-name').value = r.name;
                    document.getElementById('form-title').innerText = "‚úèÔ∏è Bearbeiten: " + r.name;
                    document.getElementById('btn-cancel-edit').style.display = "inline-block";
                    document.getElementById('scan-card').classList.add("editing-highlight");
                    
                    if(r.meta) {
                        document.getElementById('meta-desc').value = r.meta.description || "";
                        document.getElementById('meta-age').value = r.meta.age_recommendation || "";
                        document.getElementById('meta-genre').value = r.meta.genre || "H√∂rspiel";
                        document.getElementById('meta-runtime').value = r.meta.runtime || "";
                    }
                    document.getElementById('audio-info').innerText = r.playlistFileNames ? r.playlistFileNames.length + " Tracks" : "Keine";
                    const isHidden = hiddenTracks.has(id) || r.hiddenInLib === true;
                    document.getElementById('track-hidden-lib').checked = isHidden;
                    document.getElementById('scan-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            };
        }

        function cancelEdit() {
            editingOriginalTagId = null;
            document.getElementById('track-name').value = ""; document.getElementById('audio-input').value = "";
            document.getElementById('cue-input').value = ""; document.getElementById('img-input').value = "";
            document.getElementById('meta-desc').value = ""; document.getElementById('audio-info').innerText = "";
            document.getElementById('form-title').innerText = "üéµ Tag bearbeiten / anlernen";
            document.getElementById('btn-cancel-edit').style.display = "none";
            document.getElementById('scan-card').classList.remove("editing-highlight");
        }

        function createLibCard(track, isSmall = false) {
            const div = document.createElement('div');
            div.className = isSmall ? 'recent-card' : 'lib-card';
            div.onclick = () => { closeLibrary(); playTrackByTag(track.tagId); };

            let imgHtml = `<div class="lib-placeholder">üéµ</div>`;
            if (track.imageBlob) {
                const url = URL.createObjectURL(track.imageBlob);
                activeCoverUrls.push(url); imgHtml = `<img src="${url}" class="lib-cover-img" loading="lazy">`;
            }
            let infoBtnHtml = !isSmall ? `<button class="lib-card-info-btn" onclick="showAlbumInfo(event, '${track.tagId}')">i</button>` : "";
            let metaInfo = "";
            if(!isSmall && track.meta && track.meta.runtime) metaInfo += `‚è±Ô∏è ${track.meta.runtime} min`;
            let completedBadge = track.completed ? `<div class="completed-badge">‚úÖ</div>` : "";

            div.innerHTML = `<div class="lib-cover-wrap" style="${isSmall ? 'border-radius:10px;' : ''}">${imgHtml} ${infoBtnHtml} ${completedBadge}</div>${!isSmall ? `<div class="lib-card-body"><div class="lib-card-title">${track.name}</div><span class="lib-meta-tag">${metaInfo}</span></div>` : ''}`;
            return div;
        }

        function showAlbumInfo(event, tagId) {
            event.stopPropagation(); 
            const store = db.transaction(["tracks"], "readonly").objectStore("tracks");
            store.get(tagId).onsuccess = (e) => {
                const track = e.target.result;
                if(!track) return;
                const modal = document.getElementById('lib-info-modal');
                const imgEl = document.getElementById('info-modal-img');
                if(track.imageBlob) imgEl.src = URL.createObjectURL(track.imageBlob); else imgEl.src = "";
                document.getElementById('info-modal-title').innerText = track.name;
                
                let metaText = [];
                if(track.meta) {
                    if(track.meta.age_recommendation) metaText.push(`Ab ${track.meta.age_recommendation} J.`);
                    if(track.meta.genre) metaText.push(track.meta.genre);
                    if(track.meta.runtime) metaText.push(`${track.meta.runtime} min`);
                }
                document.getElementById('info-modal-meta').innerText = metaText.join(" ‚Ä¢ ");
                const desc = (track.meta && track.meta.description) ? track.meta.description : "";
                document.getElementById('info-modal-desc').innerText = desc;
                modal.style.display = 'flex';
            };
        }
        function closeAlbumInfo() { document.getElementById('lib-info-modal').style.display = 'none'; }

        function openLibrary() {
            if(!db) { showStatus("Datenbank l√§dt..."); return; }
            document.getElementById('library-mode').style.setProperty('display', 'block', 'important');
            renderLibrary();
        }
        function closeLibrary() {
            document.getElementById('library-mode').style.display = 'none';
            if(activeCoverUrls.length > 0) { activeCoverUrls.forEach(url => URL.revokeObjectURL(url)); activeCoverUrls = []; }
        }

        function renderLibrary() {
            const contentArea = document.getElementById('lib-content-area');
            const filterContainer = document.getElementById('lib-filters');
            contentArea.innerHTML = "";
            const store = db.transaction(["tracks"], "readonly").objectStore("tracks");
            const request = store.getAll();

            request.onsuccess = (e) => {
                let tracks = e.target.result;
                tracks = tracks.filter(t => t.tagId !== "system_bg" && t.tagId !== "system_settings");
                tracks.sort((a, b) => a.name.localeCompare(b.name, 'de', { sensitivity: 'base' }));
                const ageLimit = (settings.libMaxAge !== undefined) ? settings.libMaxAge : 99;
                tracks = tracks.filter(t => {
                    if (hiddenTracks.has(t.tagId)) return false; 
                    const trackAge = (t.meta && t.meta.age_recommendation) ? parseInt(t.meta.age_recommendation) : 0;
                    return trackAge <= ageLimit;
                });

                if(filterContainer.children.length <= 2) { 
                    const genres = new Set(); const ages = new Set();
                    tracks.forEach(t => { if(t.meta) { if(t.meta.genre) genres.add(t.meta.genre); if(t.meta.age_recommendation) ages.add(t.meta.age_recommendation); } });
                    Array.from(ages).sort((a,b)=>a-b).forEach(age => addFilterChip(`Ab ${age} Jahren`, `age_${age}`));
                    Array.from(genres).sort().forEach(genre => addFilterChip(genre, `genre_${genre}`));
                }

                if (currentLibFilter === 'all' || currentLibFilter === 'recent') {
                    const recentTracks = [...tracks].filter(t => t.lastPlayedTimestamp).sort((a, b) => b.lastPlayedTimestamp - a.lastPlayedTimestamp).slice(0, 3);
                    if (recentTracks.length > 0) {
                        const recentDiv = document.createElement('div');
                        recentDiv.innerHTML = `<div class="section-title">Zuletzt geh√∂rt üïí</div><div class="recent-grid" id="recent-grid-target"></div>`;
                        contentArea.appendChild(recentDiv);
                        const target = recentDiv.querySelector('#recent-grid-target');
                        recentTracks.forEach(t => target.appendChild(createLibCard(t, true)));
                    }
                }
                if (currentLibFilter === 'recent') return; 

                const gridDiv = document.createElement('div');
                gridDiv.className = 'library-grid';
                if(currentLibFilter === 'all') gridDiv.style.marginTop = "10px";
                
                let filteredTracks = tracks;
                if (currentLibFilter.startsWith('age_')) {
                    const age = parseInt(currentLibFilter.split('_')[1]);
                    filteredTracks = tracks.filter(t => t.meta && t.meta.age_recommendation == age);
                } else if (currentLibFilter.startsWith('genre_')) {
                    const g = currentLibFilter.replace('genre_', '');
                    filteredTracks = tracks.filter(t => t.meta && t.meta.genre === g);
                }
                filteredTracks.forEach(t => gridDiv.appendChild(createLibCard(t)));
                contentArea.appendChild(gridDiv);
            };
        }

        function addFilterChip(label, value) {
            const container = document.getElementById('lib-filters');
            if(container.querySelector(`[data-val="${value}"]`)) return;
            const chip = document.createElement('div');
            chip.className = 'filter-chip'; chip.innerText = label; chip.dataset.val = value;
            chip.onclick = function() { applyLibFilter(value, this); };
            container.appendChild(chip);
        }
        function applyLibFilter(filterVal, el) {
            currentLibFilter = filterVal;
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            if(el) el.classList.add('active');
            renderLibrary();
        }
        function setAdminView(mode) {
            const btnGrid = document.getElementById('btn-view-grid'); const btnList = document.getElementById('btn-view-list');
            if(mode === 'grid') { adminListView = false; btnGrid.classList.add('active'); btnList.classList.remove('active'); } 
            else { adminListView = true; btnGrid.classList.remove('active'); btnList.classList.add('active'); }
            loadTagList();
        }
        function loadTagList() {
            const container = document.getElementById('tag-list-container'); if(!container) return; 
            container.className = adminListView ? 'admin-list' : 'admin-grid';
            container.innerHTML = '<div style="text-align:center; color:#ccc; padding:20px;">Lade Eintr√§ge...</div>';
            const store = db.transaction(["tracks"], "readonly").objectStore("tracks");
            const tracks = [];
            store.openCursor().onsuccess = (event) => {
                const cursor = event.target.result;
                if (cursor) {
                    const t = cursor.value;
                    tracks.push({ tagId: t.tagId, name: t.name, imageBlob: t.imageBlob, meta: t.meta, completed: t.completed, hiddenInLib: t.hiddenInLib });
                    cursor.continue();
                } else {
                    let htmlBuffer = "";
                    tracks.sort((a, b) => a.name.localeCompare(b.name, 'de', { sensitivity: 'base' }));
                    tracks.forEach(track => {
                        if(track.tagId !== "system_bg" && track.tagId !== "system_settings") {
                            const isHidden = hiddenTracks.has(track.tagId);
                            const visIcon = isHidden ? "üö´" : "üëÅÔ∏è";
                            const visBtnColor = isHidden ? "#555" : "#f39c12";
                            let iconHtml = `<div class="list-icon">üéµ</div>`;
                            if (track.imageBlob) { const url = URL.createObjectURL(track.imageBlob); iconHtml = `<img src="${url}" class="${adminListView ? 'list-img-small' : 'admin-cover-img'}" loading="lazy">`; }
                            
                            if(adminListView) {
                                htmlBuffer += `<div class="admin-list-row">${iconHtml}<div class="list-info"><div class="list-name">${track.name}</div><div class="list-meta">ID: ${track.tagId}</div></div><div class="admin-actions"><button class="btn-mini edit" onclick="loadTagForEdit('${track.tagId}')">‚úèÔ∏è</button><button id="btn-vis-${track.tagId}" class="btn-mini vis" style="background-color:${visBtnColor};" onclick="toggleTrackVisibility('${track.tagId}')">${visIcon}</button><button class="btn-mini del" onclick="deleteTrack('${track.tagId}')">üóë</button></div></div>`;
                            } else {
                                htmlBuffer += `<div class="admin-card"><div class="admin-cover-wrap">${iconHtml}</div><div class="admin-card-body"><div class="admin-card-title">${track.name}</div><div class="admin-actions"><button class="btn-mini edit" onclick="loadTagForEdit('${track.tagId}')">‚úèÔ∏è</button><button id="btn-vis-${track.tagId}" class="btn-mini vis" style="background-color:${visBtnColor};" onclick="toggleTrackVisibility('${track.tagId}')">${visIcon}</button><button class="btn-mini play" onclick="playTrackByTag('${track.tagId}')">‚ñ∂</button><button class="btn-mini del" onclick="deleteTrack('${track.tagId}')">üóë</button></div></div></div>`;
                            }
                        } 
                    });
                    container.innerHTML = htmlBuffer;
                }
            };
        }
        function toggleTrackVisibility(id) {
            if(hiddenTracks.has(id)) { hiddenTracks.delete(id); showStatus("Sichtbar üëÅÔ∏è"); } 
            else { hiddenTracks.add(id); showStatus("Versteckt üö´"); }
            saveSettings(); loadTagList();
        }
        function setAllLibraryVisibility(isHidden) {
            if(!confirm(isHidden ? "Alle verstecken?" : "Alle anzeigen?")) return;
            const store = db.transaction(["tracks"], "readonly").objectStore("tracks");
            store.getAllKeys().onsuccess = (e) => {
                e.target.result.forEach(k => { if(k !== SYSTEM_BG_ID && k !== SYSTEM_SETTINGS_ID) { if(isHidden) hiddenTracks.add(k); else hiddenTracks.delete(k); } });
                saveSettings(); loadTagList(); showStatus("Fertig! ‚úÖ");
            };
        }
        function deleteTrack(id) { if(confirm("L√∂schen?")) { const tx = db.transaction(["tracks"], "readwrite"); tx.objectStore("tracks").delete(id); tx.oncomplete = () => { hiddenTracks.delete(id); saveSettings(); loadTagList(); }; } }
        function clearDatabase() { if(confirm("L√∂schen?")) { db.close(); indexedDB.deleteDatabase(DB_NAME); localStorage.removeItem('lastActiveTagId'); location.reload(); } }
        function autoFillName() { const input = document.getElementById('audio-input'); if (input.files.length > 0 && document.getElementById('track-name').value === "") document.getElementById('track-name').value = input.files[0].name.replace(/\.[^/.]+$/, ""); }
        function handleSecretSwitch() { clickCount++; setTimeout(() => { clickCount = 0; }, 2000); if (clickCount >= 5) { safeDisplay('kids-mode', 'none'); safeDisplay('parent-mode', 'flex'); if(typeof closeLibrary==="function") closeLibrary(); isParentMode=true; clickCount=0; releaseWakeLock(); endSessionLog(); if(document.exitFullscreen) document.exitFullscreen().catch(()=>{}); } }
        function goToKidsMode() { safeDisplay('parent-mode', 'none'); safeDisplay('kids-mode', 'flex'); isParentMode=false; applyKidsDesign(); applyButtonColors(); enterFullscreenSafe(); if(settings.enableEcoMode) updateEcoModeState(false); requestWakeLock(); startNFC().catch(console.error); }
        function enterFullscreenSafe() { const e = document.documentElement; if(e.requestFullscreen) e.requestFullscreen().catch(()=>{}); }
        
        function parseCueSheet(cueText) {
            const tracks = []; const lines = cueText.split('\n'); let currentTrack = null;
            lines.forEach(line => {
                line = line.trim();
                if (line.startsWith('TRACK')) currentTrack = {};
                if (line.startsWith('TITLE') && currentTrack) { const match = line.match(/"([^"]+)"/); if (match) currentTrack.title = match[1]; }
                if (line.startsWith('INDEX 01') && currentTrack) {
                    const p = line.split(' ')[2].split(':');
                    currentTrack.time = (parseInt(p[0])*60) + parseInt(p[1]) + (parseInt(p[2])/75); 
                    tracks.push(currentTrack); currentTrack = null;
                }
            }); return tracks;
        }

        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }
    </script>
</body>
</html>
